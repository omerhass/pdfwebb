{% extends "base.html" %}
{% set active = 'home' %}

{% block content %}
<section class="hero">
  <div class="container">
    <h1>PDF إلى نص (TXT) وصور (JPG)</h1>
    <p>حوّل ملفات PDF إلى نص قابل للنسخ واستخرج الصور المضمّنة بسهولة.</p>
  </div>
</section>

<section>
  <div class="container">
    <div class="card">
      <form id="form" action="/upload" method="post" enctype="multipart/form-data" class="center" style="flex-direction:column;gap:12px">
        <!-- مُدخل الملفات الفعلي -->
        <input id="file" name="files" type="file" accept="application/pdf" multiple hidden />

        <!-- زر اختيار الملف على طريقة iLovePDF -->
        <div style="text-align:center">
          <button type="button" id="pick" class="btn" style="font-size:18px">اختر ملفات PDF</button>
          <div class="sub">أو اسحبها هنا</div>
        </div>

        <!-- منطقة السحب والإفلات -->
        <div id="drop" class="drop" style="max-width:720px">اسحب ملفات PDF هنا</div>

        <!-- قائمة الملفات المختارة -->
        <ul id="filelist" style="list-style:none;padding:0;margin:10px 0;max-width:720px;width:100%"></ul>

        <!-- شريط التقدّم (مرئي فقط) -->
        <div class="progress" id="prog" style="height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden;display:none;max-width:720px;width:100%">
          <div class="bar" id="bar" style="height:100%;width:0;background:linear-gradient(90deg,#ef4444,#f97316)"></div>
        </div>

        <!-- أزرار الإجراء -->
        <div class="center" style="margin-top:6px">
          <button type="submit" class="btn" style="font-size:16px">بدء المعالجة</button>
        </div>

        <!-- عدّاد الملفات -->
        <div id="count" class="sub" style="text-align:center;margin-top:6px">لا توجد ملفات محددة</div>
      </form>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
  const fileInput = document.getElementById('file');
  const pick      = document.getElementById('pick');
  const drop      = document.getElementById('drop');
  const form      = document.getElementById('form');
  const listEl    = document.getElementById('filelist');
  const countEl   = document.getElementById('count');
  const prog      = document.getElementById('prog');
  const bar       = document.getElementById('bar');

  // فتح مُنتقي الملفات
  pick.onclick = () => fileInput.click();

  // تحديث القائمة والعدّاد
  function renderList(files){
    listEl.innerHTML = '';
    [...files].forEach(f=>{
      const li = document.createElement('li');
      li.style.cssText = "display:flex;justify-content:space-between;align-items:center;background:#fff;border:1px dashed #e5e7eb;border-radius:12px;padding:8px 12px;margin-top:8px;color:#374151";
      li.innerHTML = `<span>${f.name}</span>
                      <span style="font-size:12px;color:#fff;background:#ef4444;padding:2px 8px;border-radius:999px">
                        ${(f.size/1048576).toFixed(2)} MB
                      </span>`;
      listEl.appendChild(li);
    });
    countEl.textContent = files.length ? `${files.length} ملف/ملفات محددة` : 'لا توجد ملفات محددة';
  }

  // سلوك السحب والإفلات
  ['dragenter','dragover'].forEach(ev=>{
    drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.add('drag'); });
  });
  ['dragleave','drop'].forEach(ev=>{
    drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.remove('drag'); });
  });
  drop.addEventListener('drop', e=>{
    fileInput.files = e.dataTransfer.files;
    renderList(fileInput.files);
  });

  // عند التغيير عبر المُنتقي
  fileInput.addEventListener('change', ()=> renderList(fileInput.files));

  // إظهار تقدّم بصري بسيط عند الإرسال
  form.addEventListener('submit', (e)=>{
    if(!fileInput.files?.length){
      e.preventDefault();
      alert('اختر ملف PDF أولاً.');
      return;
    }
    prog.style.display='block';
    let pct = 10;
    const id = setInterval(()=>{
      pct = Math.min(95, pct+3);
      bar.style.width = pct + '%';
    }, 120);
    // سيكمل إلى 100% بعد ردّ الخادم (تبديل الصفحة/التحميل).
  });
</script>
{% endblock %}
