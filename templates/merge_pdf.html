{% extends "base.html" %}
{% set active = 'merge' %}

{% block content %}
<section class="hero">
  <div class="container" style="padding-bottom:32px">
    <div class="card" style="max-width:820px;margin:auto">
      <h1 style="margin:6px 0 12px" data-i18n="merge_title">دمج ملفات PDF</h1>
      <p class="sub" style="margin:0 0 14px" data-i18n="merge_subtitle">
        اسحب ملفات PDF إلى الصندوق وسيتم دمجها بالترتيب.
      </p>

      <form id="mergeForm" action="/api/merge-pdf" method="post" enctype="multipart/form-data"
            style="display:flex;flex-direction:column;gap:14px">

        <!-- نرسل لغة الواجهة للباكند -->
        <input type="hidden" name="lang" id="mergeLang">

        <input id="pdfs" type="file" name="files" accept="application/pdf" multiple hidden />

        <div style="text-align:center">
          <button type="button" id="pickPdf" class="btn" data-i18n="merge_choose_files">
            اختر ملفات PDF
          </button>
          <div class="sub" data-i18n="merge_or_drag_here">أو اسحبها هنا</div>
        </div>

        <div id="pdfDrop" class="drop" data-i18n="merge_drop_here">اسحب ملفات PDF هنا</div>

        <div class="row">
          <input type="text" name="outfile" value="merged.pdf" placeholder="اسم الملف الناتج">
          <select name="order" title="الترتيب">
            <option value="name" data-i18n="merge_order_name">حسب الاسم (تصاعدي)</option>
            <option value="as_is" data-i18n="merge_order_as_is">كما تم اختيارها</option>
          </select>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-start">
          <button type="submit" class="btn" data-i18n="merge_now">دمج الآن</button>
          <a class="btn muted" href="/" data-i18n="merge_back_to_img2pdf">الرجوع للصور → PDF</a>
        </div>

        <div id="pdfCount" class="sub" data-i18n="merge_no_files">لا توجد ملفات محددة</div>
      </form>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
  const pdfs      = document.getElementById('pdfs');
  const pickPdf   = document.getElementById('pickPdf');
  const pdfDrop   = document.getElementById('pdfDrop');
  const mergeForm = document.getElementById('mergeForm');
  const pdfCount  = document.getElementById('pdfCount');
  const mergeLang = document.getElementById('mergeLang');

  function getCurrentLang(){
    return localStorage.getItem('lang') || 'ar';
  }

  // نصوص عدّاد الملفات
  const countTexts = {
    ar: {
      none: 'لا توجد ملفات محددة',
      some: n => `${n} ملف/ملفات محددة`
    },
    en: {
      none: 'No files selected',
      some: n => `${n} file(s) selected`
    },
    tr: {
      none: 'Seçili dosya yok',
      some: n => `${n} dosya seçildi`
    }
  };

  // نصوص رسالة التنبيه
  const alertTexts = {
    ar: 'اختر ملفات أولاً.',
    en: 'Please select PDF files first.',
    tr: 'Lütfen önce PDF dosyaları seçin.'
  };

  function syncLangField(){
    const lang = getCurrentLang();
    if (mergeLang) mergeLang.value = lang;
  }
  syncLangField();

  pickPdf.onclick = ()=> pdfs.click();

  ['dragenter','dragover'].forEach(ev=>{
    pdfDrop.addEventListener(ev, e=>{
      e.preventDefault();
      pdfDrop.classList.add('drag');
    });
  });
  ['dragleave','drop'].forEach(ev=>{
    pdfDrop.addEventListener(ev, e=>{
      e.preventDefault();
      pdfDrop.classList.remove('drag');
    });
  });

  pdfDrop.addEventListener('drop', e=>{
    e.preventDefault();
    pdfDrop.classList.remove('drag');
    pdfs.files = e.dataTransfer.files;
    updateCount();
  });

  pdfs.addEventListener('change', updateCount);

  function updateCount(){
    const n = pdfs.files?.length || 0;
    const lang = getCurrentLang();
    const t = countTexts[lang] || countTexts.ar;
    pdfCount.textContent = n ? t.some(n) : t.none;
  }

  // تحديث مبدئي حسب اللغة المخزنة
  updateCount();

  mergeForm.addEventListener('submit', (e)=>{
    if(!pdfs.files?.length){
      e.preventDefault();
      const lang = getCurrentLang();
      alert(alertTexts[lang] || alertTexts.ar);
    }else{
      syncLangField();
    }
  });

  // لو تغيّرت اللغة من الـ select في الهيدر
  window.addEventListener('storage', (e)=>{
    if (e.key === 'lang'){
      syncLangField();
      updateCount();
    }
  });
</script>
{% endblock %}
