{% extends "base.html" %}
{% set active = 'compress' %}

{% block content %}
<section class="hero">
  <div class="container" style="padding-bottom:32px">
    <div class="card" style="max-width:820px;margin:auto">
      <h1 style="margin:6px 0 12px" data-i18n="compress_title">ضغط ملفات PDF</h1>
      <p class="sub" style="margin:0 0 14px" data-i18n="compress_subtitle">
        قلّل حجم ملف PDF مع الحفاظ على جودة مناسبة. اختر المستوى المناسب لك.
      </p>

      <form id="cmpForm" action="/api/compress-pdf" method="post" enctype="multipart/form-data"
            style="display:flex;flex-direction:column;gap:14px">

        <!-- نرسل لغة الواجهة للباكند -->
        <input type="hidden" name="lang" id="cmpLang">

        <input id="pdf" type="file" name="file" accept="application/pdf" hidden />

        <div style="text-align:center">
          <button type="button" id="pick" class="btn" data-i18n="compress_choose_file">
            اختر ملف PDF
          </button>
          <div class="sub" data-i18n="compress_or_drag">أو اسحبه إلى الصندوق أدناه</div>
        </div>

        <div id="drop" class="drop" data-i18n="compress_drop_here">اسحب ملف PDF هنا</div>

        <div class="row">
          <!-- مهم: name="level" نفس اسم الحقل في API -->
          <select name="level" title="الجودة">
            <option value="medium" selected data-i18n="compress_level_medium">متوسط (موصى به)</option>
            <option value="low" data-i18n="compress_level_low">منخفض (أصغر حجم)</option>
            <option value="high" data-i18n="compress_level_high">مرتفع (أفضل جودة)</option>
          </select>

          <select name="dpi" title="إعادة تحجيم الصور">
            <option value="" data-i18n="compress_dpi_none">بدون إعادة تحجيم</option>
            <option value="150" selected data-i18n="compress_dpi_150">150 DPI</option>
            <option value="120" data-i18n="compress_dpi_120">120 DPI</option>
            <option value="96" data-i18n="compress_dpi_96">96 DPI</option>
            <option value="72" data-i18n="compress_dpi_72">72 DPI (أصغر)</option>
          </select>

          <label class="chip">
            <input type="checkbox" name="grayscale" value="1">
            <span data-i18n="compress_grayscale">تدرّج رمادي (أصغر للحفظ)</span>
          </label>

          <input type="text" name="outfile" value="compressed.pdf" placeholder="اسم الملف الناتج">
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button type="submit" class="btn" data-i18n="compress_now">اضغط الآن</button>
          <a href="/" class="btn muted" data-i18n="compress_back_to_img2pdf">الرجوع للصور → PDF</a>
        </div>

        <div id="count" class="sub">لا يوجد ملف محدد</div>
      </form>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
  const f       = document.getElementById('pdf');
  const pick    = document.getElementById('pick');
  const drop    = document.getElementById('drop');
  const form    = document.getElementById('cmpForm');
  const count   = document.getElementById('count');
  const cmpLang = document.getElementById('cmpLang');

  function getCurrentLang(){
    return localStorage.getItem('lang') || 'ar';
  }

  // نصوص عدّاد الملف
  const countTexts = {
    ar: { none: 'لا يوجد ملف محدد' },
    en: { none: 'No file selected' },
    tr: { none: 'Seçili dosya yok' }
  };

  // نصوص رسالة التنبيه
  const alertTexts = {
    ar: 'اختر ملف PDF أولاً.',
    en: 'Please select a PDF file first.',
    tr: 'Lütfen önce bir PDF dosyası seçin.'
  };

  function syncLangField(){
    const lang = getCurrentLang();
    if (cmpLang) cmpLang.value = lang;
  }
  syncLangField();

  pick.onclick = ()=> f.click();

  ['dragenter','dragover'].forEach(ev=>{
    drop.addEventListener(ev, e=>{
      e.preventDefault();
      drop.classList.add('drag');
    });
  });

  ['dragleave','drop'].forEach(ev=>{
    drop.addEventListener(ev, e=>{
      e.preventDefault();
      drop.classList.remove('drag');
    });
  });

  drop.addEventListener('drop', e=>{
    e.preventDefault();
    drop.classList.remove('drag');
    f.files = e.dataTransfer.files;
    updateCount();
  });

  f.addEventListener('change', updateCount);

  function updateCount(){
    const lang = getCurrentLang();
    const t = countTexts[lang] || countTexts.ar;
    const n = f.files?.length || 0;
    if (!n){
      count.textContent = t.none;
    } else {
      // لو في ملف، نعرض اسمه كما هو
      count.textContent = f.files[0].name;
    }
  }

  // تحديث مبدئي للنص حسب اللغة المخزّنة
  updateCount();

  form.addEventListener('submit', (e)=>{
    if(!f.files?.length){
      e.preventDefault();
      const lang = getCurrentLang();
      alert(alertTexts[lang] || alertTexts.ar);
    } else {
      syncLangField();
    }
  });

  // لو تغيّرت اللغة من الـ select في الهيدر
  window.addEventListener('storage', (e)=>{
    if (e.key === 'lang'){
      syncLangField();
      // لو ما في ملف، نحدّث النص حسب اللغة الجديدة
      updateCount();
    }
  });
</script>
{% endblock %}
